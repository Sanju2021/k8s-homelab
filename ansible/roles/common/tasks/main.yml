---
##############################################################################
# Role: common — Base OS hardening, packages, and kernel settings
# Applied to: ALL nodes
##############################################################################

# ─── System Updates ─────────────────────────────────────────────────────────
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Upgrade all packages
  ansible.builtin.apt:
    upgrade: dist
    autoremove: true

- name: Install common packages
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - software-properties-common
      - vim
      - git
      - wget
      - net-tools
      - iputils-ping
      - htop
      - iotop
      - nfs-common
      - open-iscsi
      - ntp
      - chrony
      - python3-pip
      - jq
    state: present

# ─── NTP / Chrony ───────────────────────────────────────────────────────────
- name: Configure chrony NTP
  ansible.builtin.template:
    src: chrony.conf.j2
    dest: /etc/chrony/chrony.conf
    owner: root
    group: root
    mode: '0644'
  notify: Restart chrony

- name: Enable and start chrony
  ansible.builtin.service:
    name: chrony
    enabled: true
    state: started

# ─── Kernel Parameters (required for Kubernetes) ────────────────────────────
- name: Load required kernel modules
  ansible.builtin.modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - overlay
    - br_netfilter

- name: Persist kernel modules
  ansible.builtin.copy:
    dest: /etc/modules-load.d/k8s.conf
    content: |
      overlay
      br_netfilter
    mode: '0644'

- name: Set sysctl parameters for Kubernetes
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: true
  loop:
    - { key: "net.bridge.bridge-nf-call-iptables",  value: "1" }
    - { key: "net.bridge.bridge-nf-call-ip6tables", value: "1" }
    - { key: "net.ipv4.ip_forward",                  value: "1" }
    - { key: "net.ipv4.tcp_keepalive_time",          value: "600" }
    - { key: "net.ipv4.tcp_keepalive_intvl",         value: "60" }
    - { key: "vm.swappiness",                        value: "0" }
    - { key: "fs.inotify.max_user_watches",          value: "524288" }

# ─── Disable Swap (required for Kubernetes) ──────────────────────────────────
- name: Disable swap immediately
  ansible.builtin.command: swapoff -a
  changed_when: false

- name: Disable swap in fstab
  ansible.builtin.replace:
    path: /etc/fstab
    regexp: '^([^#].*\s+swap\s+.*)$'
    replace: '# \1'

# ─── SSH Hardening ───────────────────────────────────────────────────────────
- name: Harden SSH configuration
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
  loop:
    - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
    - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
    - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
    - { regexp: '^#?X11Forwarding', line: 'X11Forwarding no' }
    - { regexp: '^#?MaxAuthTries', line: 'MaxAuthTries 3' }
  notify: Restart sshd

# ─── UFW Firewall ────────────────────────────────────────────────────────────
- name: Install UFW
  ansible.builtin.apt:
    name: ufw
    state: present

- name: Set UFW default policies
  community.general.ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  loop:
    - { direction: incoming, policy: deny }
    - { direction: outgoing, policy: allow }

- name: Allow SSH
  community.general.ufw:
    rule: allow
    port: "22"
    proto: tcp

- name: Enable UFW
  community.general.ufw:
    state: enabled

# ─── Set Hostname ────────────────────────────────────────────────────────────
- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"

- name: Update /etc/hosts
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1'
    line: "127.0.1.1 {{ inventory_hostname }}"
